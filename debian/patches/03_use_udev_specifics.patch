Description: Use udev-in-Debian specific tools for the waiting script
 This is inspired from alsa-utils'
Author: Didier Raboud <odyx@debian.org>
Origin: vendor
Last-Update: 2013-09-17
--- a/usb_modeswitch.sh
+++ b/usb_modeswitch.sh
@@ -66,9 +66,9 @@
 	--symlink-name)
 		device_in "link_list" $v_id $p_id
 		if [ "$?" = "1" ]; then
-			if [ -e "/usr/sbin/usb_modeswitch_dispatcher" ]; then
-				exec usb_modeswitch_dispatcher $1 $2 2>>/dev/null
-			fi
+			. /lib/udev/hotplug.functions
+			wait_for_file /usr/sbin/usb_modeswitch_dispatcher
+			exec usb_modeswitch_dispatcher $1 $2 2>>/dev/null
 		fi
 		exit 0
 		;;
@@ -79,12 +79,8 @@
 EOF
 #sleep 10
 PATH=/bin:/sbin:/usr/bin:/usr/sbin
-count=20
-while [ $count != 0 ]; do
-	if [ ! -e "/usr/sbin/usb_modeswitch_dispatcher" ]; then
-		sleep 1
-		count=$(($count - 1))
-	else
+		. /lib/udev/hotplug.functions
+		wait_for_file /usr/sbin/usb_modeswitch_dispatcher
 		if [ -e "/etc/systemd/system/usb_modeswitch@.service" ]; then
 			exec systemctl --no-block start usb_modeswitch@$p1'_'$p2.service
 		elif [ -e "/etc/init/usb-modeswitch-upstart.conf" ]; then
@@ -93,8 +89,6 @@
 			exec usb_modeswitch_dispatcher --switch-mode $1 &
 		fi
 		exit 0
-	fi
-done
 ) &
 # >/dev/null 2>/dev/null
 exit 0
